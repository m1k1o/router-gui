<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Router</title>

    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

	<link href="styles/bootstrap.css" rel="stylesheet" type="text/css" />
    <link href="styles/design.css" rel="stylesheet" type="text/css" />
</head>
<body>
    <!--
    <div class="timers">
        <div class="timer">
            <div class="label" style="width:20%;">Update Timer</div>
            <div class="true" style="width:5%;">&nbsp;</div>
            <div class="false" style="width:75%;">&nbsp;</div>
        </div>
        <div class="timer">
            <div class="label" style="width:20%;">Invalid Timer</div>
            <div class="true" style="width:20%;">&nbsp;</div>
            <div class="false" style="width:60%;">&nbsp;</div>
        </div>
        <div class="timer">
            <div class="label" style="width:20%;">Holddown Timer</div>
            <div class="false" style="width:20%;">&nbsp;</div>
            <div class="true" style="width:20%;">&nbsp;</div>
            <div class="false" style="width:40%;">&nbsp;</div>
        </div>
        <div class="timer">
            <div class="label" style="width:20%;">Flush Timer</div>
            <div class="true" style="width:30%;">&nbsp;</div>
            <div class="false" style="width:50%;">&nbsp;</div>
        </div>
    </div>
    -->

    <div id="app" class="container mt-3">
        <div class="float-right btn-group">
            <button class="btn btn-success" v-on:click="DefaultSettings();" v-if="running">Default Settings</button>
            <button class="btn btn-info" v-on:click="modal = true" v-if="!running">API Settings</button>
            <button class="btn btn-danger" v-on:click="Stop();" v-if="running">Pause Requests</button>
            <button class="btn btn-success" v-on:click="Start();" v-if="!running">Start Requests</button>
        </div>

        <h3 class="mb-3">Router</h3>
        
        <interfaces v
            :running="running"

            :fetch_data="false"
            :table="interfaces_table"

            :services="services"
        ></interfaces>

        <arp
            :running="running"

            :fetch_data="false"
            :table="arp_table"
        ></arp>
            
        <routing
            :running="running"

            :fetch_data="false"
            :table="routing_table"
        ></routing>

        <rip
            :running="running"

            :fetch_data="false"
            :table="rip_table"
        ></rip>

        <modal v-if="modal" v-on:close="modal = false" v-cloak>
            <div slot="header">
                <h1 class="mb-3"> Settings </h1>
            </div>
            <div slot="body" class="form-horizontal">
                <div class="form-group row">
                    <label class="col-sm-4 col-form-label">IP Address</label>
                    <div class="col-sm-8">
                        <input type="text" class="form-control" v-model="api_hostname">
                    </div>
                </div>
                <div class="form-group row">
                    <label class="col-sm-4 col-form-label">Port</label>
                    <div class="col-sm-8">
                        <input type="text" class="form-control" v-model="api_port">
                    </div>
                </div>
            </div>
        </modal>
        
        <div class="push" v-if="push">{{ push }}</div>
    </div>

    <!-- Global scripts -->
    <script src="vue.js" type="text/javascript"></script>
    <script src="vuex.js"></script>
    <script src="components/helpers.js" type="text/javascript"></script>
    <script src="components/modal.js" type="text/javascript"></script>
    <script src="components/interfaces.js" type="text/javascript"></script>
    <script src="components/arp.js" type="text/javascript"></script>
    <script src="components/routing.js" type="text/javascript"></script>
    <script src="components/rip.js" type="text/javascript"></script>
    
    <script type="text/javascript">
        const store = new Vuex.Store({
            state: {
                running: false,

                interfaces: {
                    table: {}
                },
                arp: {
                    table: {},

                    proxy: {
                        enabled: false
                    },
                    timers: {
                        cache_timeout: 1,
                        request_timeout: 2,
                        request_interval: 3
                    }
                },
                routing: {
                    table: {},
                },
                rip: {
                    table: {},

                    interfaces: {

                    },
                    timers: {
                        update: null,
                        invalid: null,
                        hold: null,
                        flush: null,
                    }
                }
            },
            mutations: {
                UPDATE_TABLES(state, tables) {
                    for (const key in tables) {
                        if (tables.hasOwnProperty(key)) {
                            state[key].table = tables[key];
                        }
                    }
                },
                INITIALIZE(state, data) {
                    Object.assign(state, data);
                    state.running = true;
                },
                INTERFACE_EDIT(state, interface) {
                    Vue.set(state.interfaces.table, interface.id, interface);
                    /*
                    for (const key in interface) {
                        if (interface.hasOwnProperty(key) && state.interfaces.table[interface.id].hasOwnProperty(key)) {
                            state.interfaces.table[interface.id][key] = interface[key];
                            //Vue.set(state.arp.timers, key, timers[key]);
                        }
                    }
                    */
                },
                ARP_TIMERS(state, timers) {
                    for (const key in timers) {
                        if (timers.hasOwnProperty(key) && state.arp.timers.hasOwnProperty(key) && state.arp.timers[key] != timers[key]) {
                            Vue.set(state.arp.timers, key, timers[key]);
                        }
                    }
                },
                ARP_PROXY(state, proxy) {
                    for (const key in proxy) {
                        if (proxy.hasOwnProperty(key) && state.arp.proxy.hasOwnProperty(key) && state.arp.proxy[key] != proxy[key]) {
                            Vue.set(state.arp.proxy, key, proxy[key]);
                        }
                    }
                },
/*
                RIP_TIMRES(state, timers) {
                    for (const key in timers) {
                        if (timers.hasOwnProperty(key) && state.rip.timers.hasOwnProperty(key)) {
                            Vue.set(state.rip.timers, key, timers[key]);
                        }
                    }
                },
*/
            },
            getters: {

            },
            actions: {
                UPDATE_TABLES({commit}) {
                    return ajax("Global", "UpdateTables")
                    .then((tables) => commit('UPDATE_TABLES', tables));
                },
                INITIALIZE({commit}) {
                    return ajax("Global", "Initialize")
                    .then((data) => commit('INITIALIZE', data));
                },
                INTERFACE_EDIT({commit}, input) {
                    return ajax("Interfaces", "Edit", [
                        input.id,
                        input.ip,
                        input.mask
                    ]).then((interface) => {
                        commit('INTERFACE_EDIT', interface);
                    }, () => {});
                },
                ARP_TIMERS({commit}, input) {
                    return ajax("ARP", "Timers", [
                        input.cache_timeout,
                        input.request_timeout,
                        input.request_interval
                    ]).then((timers) => {
                        commit('ARP_TIMERS', timers);
                    }, () => {});
                },
                ARP_PROXY({commit}, input) {
                    return ajax("ARP", "Proxy", [
                        input.enabled.toString(),
                    ]).then((proxy) => {
                        commit('ARP_PROXY', proxy);
                    }, () => {});
                }
            }
        })

        const app = new Vue({
            el: '#app',
            store,
            data: {
                services: {},
                /*{
                    'rip': {
                        name: 'RIP',
                        running: {},
                        must_be_runnig: false,
                        //onLoad: () => {             
                        //    ajax("RIP", "Interfaces").then((response) => {
                        //        Object.keys(response).map(function(key, index) {
                        //            response[key] = response[key].active;
                        //        });
                        //
                        //        app.$set(app.services.rip, 'running', response);
                        //    }, () => {})
                        //},
                        //onUpdate: id => {},
                        start: id => {
                            ajax("RIP", "AddInterface", id).then((iface) => {
                                app.services.rip.running[id] = iface.active;
                            });
                        },
                        stop: id => {
                            ajax("RIP", "RemoveInterface", id).then((iface) => {
                                app.services.rip.running[id] = iface.active;
                            });
                        }
                    }
                },*/

                running: false,
                interval: null,
                modal: false,
                api_hostname: "localhost",
                api_port: "5000",

                interfaces_table: null,
                arp_table: null,
                routing_table: null,
                rip_table: null,
                
                // MISC
                push: null
            },
            methods: {
                DefaultSettings() {
                    ajax("Interfaces", "Edit", [1, "192.168.1.5", "255.255.0.0"].join('\n')).then((interface) => {
                        this.$set(this.interfaces_table, 1, interface);
                    }, () => {});
                    
                    ajax("Interfaces", "Edit", [3, "10.10.0.2", "255.255.0.0"].join('\n')).then((interface) => {
                        this.$set(this.interfaces_table, 3, interface);
                    }, () => {});
                },
                Push(text) {
                    this.push = text;

                    setTimeout(() => {
                        this.push = null;
                    }, 3000);
                },
                Update(){
                    ajax("Global", "Update").then((response) => {
                        this.arp_table = response.arp_table;
                        this.routing_table = response.routing_table;
                        this.rip_table = response.rip_table;
                    }, () => {})
                },
                /*
                Start(){
                    !this.running && ajax("Global", "Initialize").then((response) => {
                        this.interfaces_table = response.interfaces;
                        this.arp_table = response.arp_table;
                        this.routing_table = response.routing_table;
                        this.rip_table = response.rip_table;

                        this.running = true;
                        this.interval = setInterval(() => this.Update(), 1000)
                    }, () => {})
                },
                Stop(){
                    this.running && clearInterval(this.interval);
                    this.running = false;
                }
                */
            },
            mounted(){
                //setTimeout(() => this.Start(), 0);
            }
        });

        function ajax(model, controller, body = null) {
            if (body != null && Array.isArray(body)) {
                body = body.join("\n");
            }

            return fetch('http://'+app.api_hostname+':'+app.api_port+'/'+model+'/'+controller, { method: 'POST', body })
                .then(function(response) {
                    return response.json();
                })
                .then((response) => {
                    if(typeof response.error === 'undefined') {
                        return response;
                    }
                    
                    console.log("Error Occured.");
                    app.Push(response.error);
                    throw Error(response.error);
                }, (err) => {
                    app.Push(err.toString());
                    throw Error(err.toString());
                });
        }
    </script>
</body>

</html>